using Microsoft.Extensions.Configuration;

namespace ElectricRefueling;

class Program
{
    private static DataCache? _dataCache;
    private static DataUpdateService? _updateService;

    static async Task Main(string[] args)
    {
        _dataCache = new DataCache();

        var configuration = new ConfigurationBuilder()
            .SetBasePath(AppContext.BaseDirectory)
            .AddJsonFile("appsettings.json", optional: true)
            .AddEnvironmentVariables()
            .Build();

        var apiKey = configuration["MoscowData:ApiKey"];
        var baseUrl = configuration["MoscowData:BaseUrl"];
        var updateIntervalMinutes = configuration.GetValue<int?>("MoscowData:UpdateIntervalMinutes") ?? 60;
        var connectionString = configuration.GetConnectionString("ElectricRefueling");

        if (string.IsNullOrWhiteSpace(apiKey))
        {
            throw new InvalidOperationException("MoscowData:ApiKey is missing.");
        }
        if (string.IsNullOrWhiteSpace(connectionString))
        {
            throw new InvalidOperationException("ConnectionStrings:ElectricRefueling is missing.");
        }

        using var apiClient = new MoscowDataApiClient(apiKey, baseUrl);
        var dataStorage = new DataStorageService(connectionString);

        try
        {
            _updateService = new DataUpdateService(
                apiClient,
                _dataCache,
                dataStorage,
                updateIntervalMinutes: updateIntervalMinutes);

            Console.WriteLine("???????????????????????????? ???????????????? ????????????...");
            await _updateService.UpdateAllDataAsync();

            Console.WriteLine($"\n?????????????????? ??????????????: {_dataCache.StationsCount}");
            Console.WriteLine($"?????????????????? ???????????????? ??????????: {_dataCache.RoadWorksCount}");
            Console.WriteLine($"?????????? ???????????????????? ???????????????????? ??????????????: {_dataCache.StationsLastUpdate:yyyy-MM-dd HH:mm:ss}");
            Console.WriteLine($"?????????? ???????????????????? ???????????????????? ???????????????? ??????????: {_dataCache.RoadWorksLastUpdate:yyyy-MM-dd HH:mm:ss}");
            
            Console.WriteLine("\n???????????? ???????????????????? ???????????? ??????????????. ???????????? ?????????? ?????????????????????????? ??????????????????????.");
            Console.WriteLine("?????????????? ?????????? ?????????????? ?????? ????????????...\n");

            await DemonstrateDataUsageAsync();

            Console.ReadKey();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"?????????????????? ????????????: {ex.Message}");
            Console.WriteLine($"StackTrace: {ex.StackTrace}");
        }
        finally
        {
            _updateService?.Dispose();
        }
    }

    static async Task DemonstrateDataUsageAsync()
    {
        for (int i = 0; i < 3; i++)
        {
            await Task.Delay(2000);

            if (_dataCache == null) continue;

            var stations = _dataCache.GetStations();
            var roadWorks = _dataCache.GetRoadWorks();

            Console.WriteLine($"[???????????????????????? {i + 1}] ???????????????? ???? ????????:");
            Console.WriteLine($"  - ??????????????: {stations.Count}");
            Console.WriteLine($"  - ???????????????? ??????????: {roadWorks.Count}");

            if (stations.Count > 0)
            {
                var firstStation = stations[0];
                Console.WriteLine($"  - ???????????? ??????????????: {firstStation.StationName} ({firstStation.Address})");
            }
        }
    }
}

